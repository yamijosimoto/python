USE [BCS_TRSR]
GO

/******** Object: StoredProcedure [dbo].[usp_STL_QORT_GetCYCAccounts_test] Script Date: 28.01.2026 17:38:37 *******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[usp_STL_QORT_GetCYCAccounts_test]
    @date DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    IF @date IS NULL
        SET @date = GETDATE();

    DECLARE @from DATE = DATEADD(DAY, -5, @date);
    DECLARE @to DATE = DATEADD(DAY, 1, @date);
    DECLARE @has_accounts BIT = 0;

    CREATE TABLE #Accounts (
        AccountNumber VARCHAR(300) NOT NULL PRIMARY KEY
    );

    INSERT INTO #Accounts (AccountNumber)
    SELECT DISTINCT a.AccountNumber
    FROM BCS_TRSR.dbo.STL_CF_Nostro_Mapping_test_2 m
    CROSS APPLY (
        SELECT NULLIF(
            REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(m.ACCOUNT_NUMBER)), ' ', ''), CHAR(9), ''), CHAR(160), ''),
            ''
        ) AS AccountNumber
    ) a
    WHERE m.SOURCE = 'QORT'
      AND a.AccountNumber IS NOT NULL;

    IF EXISTS (SELECT 1 FROM #Accounts)
        SET @has_accounts = 1;

    CREATE TABLE #Temp (
        Name VARCHAR(256),
        LASTDATE INT,
        Volume MONEY,
        Volume_2 MONEY,
        CurrencyCode VARCHAR(256)
    );

    INSERT INTO #Temp (Name, LASTDATE, Volume, Volume_2, CurrencyCode)
    SELECT
        sc.Name,
        CONVERT(INT, CONVERT(VARCHAR(8), t.LASTDATE, 112)),
        SUM(t.Volume) AS Volume,
        SUM(t.Volume) AS Volume_2,
        t.CurrencyCode
    FROM BCS_STG.calypso.PositionsClient AS t
    JOIN BCS_STG.CALYPSO.STORAGE sc ON t.StorageID = sc.ID
    CROSS APPLY (
        SELECT
            REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(sc.Name)), ' ', ''), CHAR(9), ''), CHAR(160), '') AS NameNorm,
            REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(sc.Code)), ' ', ''), CHAR(9), ''), CHAR(160), '') AS CodeNorm
    ) scn
    WHERE t.LASTDATE >= @from
      AND t.LASTDATE < @to
      AND (
          @has_accounts = 0
          OR EXISTS (
              SELECT 1
              FROM #Accounts a
              WHERE a.AccountNumber = scn.NameNorm
                 OR a.AccountNumber = scn.CodeNorm
          )
      )
    GROUP BY sc.Name, t.LASTDATE, t.CurrencyCode;

    DELETE FROM BCS_TRSR.dbo.STL_ArdshinRestQORT_test_1
    WHERE LASTDATE >= CONVERT(INT, CONVERT(VARCHAR(8), @from, 112))
      AND LASTDATE < CONVERT(INT, CONVERT(VARCHAR(8), @to, 112));

    INSERT INTO BCS_TRSR.dbo.STL_ArdshinRestQORT_test_1 (Name, LASTDATE, Volume, Volume_2, CurrencyCode)
    SELECT
        t.Name,
        t.LASTDATE,
        t.Volume,
        t.Volume_2,
        t.CurrencyCode
    FROM #Temp t;

END
GO    


SELECT
    sc.Name,
    CONVERT(INT, CONVERT(VARCHAR(8), t.LASTDATE, 112)) AS LASTDATE,
    SUM(t.Volume) AS Volume,
    SUM(t.Volume) AS Volume_2,
    t.CurrencyCode
FROM BCS_STG.calypso.PositionsClient AS t
JOIN BCS_STG.CALYPSO.STORAGE sc ON t.StorageID = sc.ID
WHERE 1=1
    AND t.LASTDATE >= CONVERT(VARCHAR(8), '20260127', 112)
GROUP BY sc.Name, t.LASTDATE, t.CurrencyCode;
